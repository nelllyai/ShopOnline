(()=>{"use strict";const t=t=>JSON.parse(localStorage.getItem(t))||[],o=(o,e)=>{const n=t(o);n.splice(n.findIndex((t=>t.id===e)),1),localStorage.setItem(o,JSON.stringify(n))},e=(o,e,n,c)=>{const i=t(o),s=i.findIndex((t=>t.id===e));i[s][n]=c,localStorage.setItem(o,JSON.stringify(i))},n=()=>{const o=t("cart").reduce(((t,o)=>t+o.quantity),0);document.querySelector(".header__link_cart").dataset.total=o},c=document.querySelector(".header__menu-button"),i=document.querySelector(".menu");c.addEventListener("click",(()=>{c.classList.toggle("header__menu-button_close"),i.classList.toggle("menu_active")})),n();const s=document.querySelectorAll(".footer__list_cover");document.querySelectorAll(".footer__button").forEach(((t,o)=>{t.addEventListener("click",(()=>{t.classList.toggle("footer__button_active");for(let t=0;t<s.length;t++)o===t&&s[t].classList.toggle("footer__list_active")}))}));const a=t=>{const o=document.createElement("li");o.className="footer__item";const e=document.createElement("a");return e.className="footer__link",e.href="category.html?search="+t,e.textContent=t,o.append(e),o},r=t=>{const o=document.createElement("li");o.className="menu__item";const e=document.createElement("a");return e.className="menu__link",e.href="category.html?search="+t,e.textContent=t,o.append(e),o};(async()=>{const t=await(async()=>{const t=await fetch("https://shorthaired-veiled-fascinator.glitch.me/api/category");return await t.json()})(),o=document.querySelector(".footer__list_two-cols"),e=document.querySelector(".menu__list_two-cols");o.append(...t.map(a)),e.append(...t.map(r))})();const l=t=>Math.round(100*t)/100+" ₽",d=(t,o,e)=>o*(t-t*e/100),_=(t,o)=>t*o,m=(t,o)=>t*o*.05,u=t=>"image/notimage.jpg"===t?"./img/no-image.png":`https://shorthaired-veiled-fascinator.glitch.me/${t}`,p=({id:t,title:o,price:e,discount:n,image:c})=>{const i=document.createElement("li");i.className="card",i.tabIndex="0";const s=u(c);return i.innerHTML=`\n  <a href="product.html?id=${t}" class="card__link">\n    <div class="card__image-wrapper">\n      <img src="${s}" alt="${o}" class="card__image" width="420" height="295">\n      ${n>0?`<div class="card__discount">-${n}%</div>`:""}\n    </div>\n  \n    <div class="card__price">\n      <p class="card__new-price">${l(d(e,1,n))}</p>\n      ${n>0?`\n      <p class="card__old-price">\n        <span class="visually-hidden">Старая цена</span>${e} ₽\n      </p>\n      `:""}\n    </div>\n  \n    <p class="card__product">${o}</p>\n  </a>\n  `,i},h="https://shorthaired-veiled-fascinator.glitch.me",y=async()=>{const t=await fetch(`${h}/api/goods`);return await t.json()},v=async t=>{const o=await fetch(`${h}/api/goods/${t}`);return await o.json()},g=o=>t("cart").find((t=>t.id===o)),f=(o,c)=>{o.addEventListener("click",(()=>{const o=g(c);o?e("cart",c,"quantity",o.quantity+1):((o,e)=>{const n=t(o);n.push(e),localStorage.setItem(o,JSON.stringify(n))})("cart",{id:c,quantity:1}),n()}))},q=()=>0===t("cart").length,S=()=>{document.querySelector("h1").textContent="В корзине пусто...";document.querySelector(".composition__controls").remove()},w=async t=>await Promise.all(t.map((async t=>(async t=>({info:await v(t.id),quantity:t.quantity}))(t)))),E=async()=>{const o=t("cart"),{totalPrice:e,totalQuantity:n,totalWithoutDiscount:c,totalDiscount:i}=await(async t=>{const o=await w(t);let e=0,n=0,c=0,i=0;return o.forEach((t=>{const{price:o,discount:s}=t.info,a=t.quantity;e+=d(o,a,s),n+=a,i+=_(o,a),c+=((t,o,e)=>o*(t*e/100))(o,a,s)})),{totalPrice:e,totalQuantity:n,totalWithoutDiscount:i,totalDiscount:c}})(o);console.log(e);document.querySelector(".composition__cost").textContent=l(e);document.querySelector(".composition__info-title_goods").textContent=`Товары, ${n} шт.`;document.querySelector(".composition__info_without-discount").textContent=l(c);document.querySelector(".composition__info_discount").textContent=l(i)};(async()=>{if(q())return void S();const o=t("cart"),e=document.querySelector(".composition__cart"),n=document.createElement("ul");n.className="composition__full-order";const c=await w(o),i=c.map((t=>(({id:t,title:o,price:e,discount:n,image:c},i)=>{const s=document.createElement("li");s.className="composition__full-product",s.dataset.id=t;const a=u(c);return s.innerHTML=`\n    <div class="composition__column composition__column_item">\n      <input type="checkbox" class="composition__checkbox composition__checkbox_item" checked>\n      <img src="${a}" alt="${o}" class="composition__product-image">\n\n      <div class="composition__wrapper">\n        <div class="composition__column composition__column_price composition__column_price_tablet">\n          <div class="composition__new-price">\n            ${l(d(e,i,n))}\n          </div>\n          ${n>0?`\n          <div class="composition__old-price">\n            ${i*e}&nbsp;₽\n          </div>`:""}\n          <div class="composition__credit">\n            В кредит от&nbsp;${l(m(e,i))}\n          </div>\n        </div>\n        <h3 class="composition__product-title">${o}</h3>\n      </div>\n    </div>\n\n    <div class="composition__column composition__column_counter">\n        <button class="composition__count-button composition__count-button_minus">-</button>\n        <p class="composition__quantity">${i}</p>\n        <button class="composition__count-button composition__count-button_plus">+</button>\n\n        <button class="composition__delete composition__delete_item">\n          <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path\n              d="M13.0214 2.35355L13.1679 2.5H13.375H17.25V4H0.75V2.5H4.625H4.83211L4.97855 2.35355L6.08211 1.25H11.9179L13.0214 2.35355ZM4 22.75C2.90114 22.75 2 21.8489 2 20.75V6.25H16V20.75C16 21.8489 15.0989 22.75 14 22.75H4Z"\n              fill="#C9C9C9" stroke="#C9C9C9" />\n          </svg>\n        </button>\n    </div>\n\n    <div class="composition__column composition__column_price composition__column_price_pc">\n      <div class="composition__new-price">\n        ${l(d(e,i,n))}\n      </div>\n      ${n>0?`\n      <div class="composition__old-price">\n        ${i*e}&nbsp;₽\n      </div>`:""}\n      <div class="composition__credit">\n        В кредит от&nbsp;${l(m(e,i))}\n      </div>\n    </div>\n  `,s})(t.info,t.quantity)));n.append(...i);const s=document.querySelector(".composition__goods"),a=c.map((t=>(({id:t,title:o,image:e})=>{const n=document.createElement("li");n.className="composition__product",n.dataset.id=t;const c=document.createElement("img");c.alt=o,c.classList.add("composition__product-image","composition__product-image_small");const i=u(e);return c.src=i,n.append(c),n})(t.info)));s.append(...a),e.append(n),await E()})();document.querySelector(".composition__checkbox_all-items").addEventListener("change",(t=>{const o=document.querySelectorAll(".composition__checkbox_item");t.target.checked?o.forEach((t=>{t.checked=!0})):o.forEach((t=>{t.checked=!1}))}));const b=document.querySelector(".composition__delete_all");b.addEventListener("click",(()=>{var t;t="cart",localStorage.removeItem(t),n()})),b.addEventListener("click",(async()=>{await E(),S(),list.remove(),previewsContainer.innerHTML=""}));document.querySelectorAll(".composition__delete_item").forEach((t=>{const e=+t.closest("li").dataset.id;((t,e)=>{t.addEventListener("click",(()=>{o("cart",e),n()}))})(t,e)}));document.querySelectorAll(".composition__count-button_plus").forEach((t=>{const o=+t.closest("li").dataset.id;f(t,o)}));document.querySelectorAll(".composition__count-button_minus").forEach((t=>{const c=+t.closest("li").dataset.id;((t,c)=>{t.addEventListener("click",(()=>{const t=g(c);t.quantity>1?e("cart",c,"quantity",t.quantity-1):o("cart",c),n()}))})(t,c)}));document.querySelectorAll(".composition__count-button, .composition__delete").forEach((t=>{t.addEventListener("click",(async()=>{await E();const o=t.closest("li"),e=+o.dataset.id,n=g(e),c=goods.find((t=>t.info.id==e));if(n){const{price:t,discount:e}=c.info,i=n.quantity;o.querySelector(".composition__quantity").textContent=i;o.querySelectorAll(".composition__new-price").forEach((o=>o.textContent=l(d(t,i,e))));o.querySelectorAll(".composition__old-price").forEach((o=>o.textContent=l(_(t,i))));o.querySelectorAll(".composition__credit").forEach((o=>o.textContent=`В кредит от ${l(m(t,i))}`))}else{o.remove();previewsContainer.querySelector(`[data-id="${e}"`).remove(),q()&&S()}}))}));(async()=>{const t=document.querySelector(".profit__container"),o=await(async()=>(await y()).filter((t=>t.discount>0)))(),e=document.createElement("h2");e.className="subtitle",e.textContent="Это выгодно!";const n=document.createElement("ul");n.className="profit__list";const c=o.map(p);n.append(...c),t.append(e,n)})()})();