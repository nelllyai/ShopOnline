(()=>{"use strict";const t=t=>JSON.parse(localStorage.getItem(t))||[],o=(o,n,e,c)=>{const i=t(o),s=i.findIndex((t=>t.id===n));i[s][e]=c,localStorage.setItem(o,JSON.stringify(i))},n=()=>{const o=t("cart").reduce(((t,o)=>t+o.quantity),0);document.querySelector(".header__link_cart").dataset.total=o},e=document.querySelector(".header__menu-button"),c=document.querySelector(".menu");e.addEventListener("click",(()=>{e.classList.toggle("header__menu-button_close"),c.classList.toggle("menu_active")})),n();const i=document.querySelectorAll(".footer__list_cover");document.querySelectorAll(".footer__button").forEach(((t,o)=>{t.addEventListener("click",(()=>{t.classList.toggle("footer__button_active");for(let t=0;t<i.length;t++)o===t&&i[t].classList.toggle("footer__list_active")}))}));const s=t=>{const o=document.createElement("li");o.className="footer__item";const n=document.createElement("a");return n.className="footer__link",n.href="category.html?search="+t,n.textContent=t,o.append(n),o},a=t=>{const o=document.createElement("li");o.className="menu__item";const n=document.createElement("a");return n.className="menu__link",n.href="category.html?search="+t,n.textContent=t,o.append(n),o};(async()=>{const t=await(async()=>{const t=await fetch("http://shorthaired-veiled-fascinator.glitch.me/api/category");return await t.json()})(),o=document.querySelector(".footer__list_two-cols"),n=document.querySelector(".menu__list_two-cols");o.append(...t.map(s)),n.append(...t.map(a))})();const l=t=>`${t.toFixed(2)} ₽`,r=(t,o,n)=>o*(t-t*n/100),d=(t,o)=>t*o,_=(t,o)=>t*o*.05,u=t=>"image/notimage.jpg"===t?"./img/no-image.png":`http://shorthaired-veiled-fascinator.glitch.me/${t}`,m=({id:t,title:o,price:n,discount:e,image:c})=>{const i=document.createElement("li");i.className="card";const s=u(c);return i.innerHTML=`\n  <a href="product.html?id=${t}" class="card__link">\n    <div class="card__image-wrapper">\n      <img src="${s}" alt="${o}" class="card__image" width="420" height="295">\n      ${e>0?`<div class="card__discount">-${e}%</div>`:""}\n    </div>\n  \n    <div class="card__price">\n      <p class="card__new-price">${l(r(n,1,e))} ₽</p>\n      ${e>0?`\n      <p class="card__old-price">\n        <span class="visually-hidden">Старая цена</span>${n} ₽\n      </p>\n      `:""}\n    </div>\n  \n    <p class="card__product">${o}</p>\n  </a>\n  `,i},p="http://shorthaired-veiled-fascinator.glitch.me",y=async()=>{const t=await fetch(`${p}/api/goods`);return await t.json()},h=async t=>{const o=await fetch(`${p}/api/goods/${t}`);return await o.json()},f=o=>t("cart").find((t=>t.id===o)),g=(e,c)=>{e.addEventListener("click",(()=>{const e=f(c);e?o("cart",c,"quantity",e.quantity+1):((o,n)=>{const e=t(o);e.push(n),localStorage.setItem(o,JSON.stringify(e))})("cart",{id:c,quantity:1}),n()}))},v=(e,c)=>{e.addEventListener("click",(()=>{const n=f(c);n.quantity>1?o("cart",c,"quantity",n.quantity-1):((o,n)=>{const e=t(o);e.splice(e.findIndex((t=>t.id===n)),1),localStorage.setItem(o,JSON.stringify(e))})("cart",c)})),n()},q=()=>0===t("cart").length,S=()=>{document.querySelector("h1").textContent="В корзине пусто...";document.querySelector(".composition__controls").remove()},$=async t=>await Promise.all(t.map((async t=>(async t=>({info:await h(t.id),quantity:t.quantity}))(t)))),w=async()=>{const o=t("cart"),{totalPrice:n,totalQuantity:e,totalWithoutDiscount:c,totalDiscount:i}=await(async t=>{const o=await $(t);let n=0,e=0,c=0,i=0;return o.forEach((t=>{const{price:o,discount:s}=t.info,a=t.quantity;n+=r(o,a,s),e+=a,i+=d(o,a),c+=((t,o,n)=>o*(t*n/100))(o,a,s)})),{totalPrice:n,totalQuantity:e,totalWithoutDiscount:i,totalDiscount:c}})(o);console.log(n);document.querySelector(".composition__cost").textContent=l(n);document.querySelector(".composition__info-title_goods").textContent=`Товары, ${e} шт.`;document.querySelector(".composition__info_without-discount").textContent=l(c);document.querySelector(".composition__info_discount").textContent=l(i)};(async()=>{if(q())return void S();const o=t("cart"),n=document.querySelector(".composition__cart"),e=document.createElement("ul");e.className="composition__full-order";const c=await $(o),i=c.map((t=>(({id:t,title:o,price:n,discount:e,image:c},i)=>{const s=document.createElement("li");s.className="composition__full-product",s.dataset.id=t;const a=u(c);return s.innerHTML=`\n    <div class="composition__column composition__column_item">\n      <input type="checkbox" class="composition__checkbox">\n      <img src="${a}" alt="${o}" class="composition__product-image">\n\n      <div class="composition__wrapper">\n        <div class="composition__column composition__column_price composition__column_price_tablet">\n          <div class="composition__new-price">\n            ${l(r(n,i,e))}\n          </div>\n          ${e>0?`\n          <div class="composition__old-price">\n            ${(i*n).toFixed(2)}&nbsp;₽\n          </div>`:""}\n          <div class="composition__credit">\n            В кредит от&nbsp;${l(_(n,i))}\n          </div>\n        </div>\n        <h3 class="composition__product-title">${o}</h3>\n      </div>\n    </div>\n\n    <div class="composition__column composition__column_counter">\n      <button class="composition__count-button composition__count-button_minus">-</button>\n      <p class="composition__quantity">${i}</p>\n      <button class="composition__count-button composition__count-button_plus">+</button>\n    </div>\n\n    <div class="composition__column composition__column_price composition__column_price_pc">\n      <div class="composition__new-price">\n        ${l(r(n,i,e))}\n      </div>\n      ${e>0?`\n      <div class="composition__old-price">\n        ${(i*n).toFixed(2)}&nbsp;₽\n      </div>`:""}\n      <div class="composition__credit">\n        В кредит от&nbsp;${l(_(n,i))}\n      </div>\n    </div>\n  `,s})(t.info,t.quantity)));e.append(...i);const s=document.querySelector(".composition__goods"),a=c.map((t=>(({title:t,image:o})=>{const n=document.createElement("li");n.className="composition__product";const e=document.createElement("img");e.alt=t,e.classList.add("composition__product-image","composition__product-image_small");const c=u(o);return e.src=c,n.append(e),n})(t.info)));s.append(...a),n.append(e),await w();document.querySelectorAll(".composition__count-button_plus").forEach((t=>{const o=+t.closest("li").dataset.id;g(t,o)}));document.querySelectorAll(".composition__count-button_minus").forEach((t=>{const o=+t.closest("li").dataset.id;v(t,o)}));document.querySelectorAll(".composition__count-button").forEach((t=>{t.addEventListener("click",(async()=>{await w();const o=t.closest("li"),n=+o.dataset.id,e=f(n),i=c.find((t=>t.info.id==n));if(e){const{price:t,discount:n}=i.info,c=e.quantity;o.querySelector(".composition__quantity").textContent=c;o.querySelectorAll(".composition__new-price").forEach((o=>o.textContent=l(r(t,c,n))));o.querySelectorAll(".composition__old-price").forEach((o=>o.textContent=l(d(t,c))));o.querySelectorAll(".composition__credit").forEach((o=>o.textContent=`В кредит от ${l(_(t,c))}`))}else o.remove(),q()&&S()}))}))})();(async()=>{const t=document.querySelector(".profit__container");t.style.display="none";const o=await(async()=>(await y()).filter((t=>t.discount>0)))(),n=document.createElement("h2");n.className="subtitle",n.textContent="Это выгодно!";const e=document.createElement("ul");e.className="profit__list";const c=o.map(m);e.append(...c),t.append(n,e)})()})();