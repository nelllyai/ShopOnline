(()=>{"use strict";const t=t=>JSON.parse(localStorage.getItem(t))||[],e=(e,o)=>{const c=t(e);c.splice(c.findIndex((t=>t.id===o)),1),localStorage.setItem(e,JSON.stringify(c))},o=(e,o,c,n)=>{const i=t(e),s=i.findIndex((t=>t.id===o));i[s][c]=n,localStorage.setItem(e,JSON.stringify(i))},c=()=>{const e=t("cart").reduce(((t,e)=>t+e.quantity),0);document.querySelector(".header__link_cart").dataset.total=e},n=document.querySelector(".header__menu-button"),i=document.querySelector(".menu");n.addEventListener("click",(()=>{n.classList.toggle("header__menu-button_close"),i.classList.toggle("menu_active")})),c();const s=document.querySelectorAll(".footer__list_cover");document.querySelectorAll(".footer__button").forEach(((t,e)=>{t.addEventListener("click",(()=>{t.classList.toggle("footer__button_active");for(let t=0;t<s.length;t++)e===t&&s[t].classList.toggle("footer__list_active")}))}));const a=t=>{const e=document.createElement("li");e.className="footer__item";const o=document.createElement("a");return o.className="footer__link",o.href="category.html?search="+t,o.textContent=t,e.append(o),e},r=t=>{const e=document.createElement("li");e.className="menu__item";const o=document.createElement("a");return o.className="menu__link",o.href="category.html?search="+t,o.textContent=t,e.append(o),e};(async()=>{const t=await(async()=>{const t=await fetch("https://shorthaired-veiled-fascinator.glitch.me/api/category");return await t.json()})(),e=document.querySelector(".footer__list_two-cols"),o=document.querySelector(".menu__list_two-cols");e.append(...t.map(a)),o.append(...t.map(r))})();const l=t=>Math.round(100*t)/100+" ₽",d=(t,e,o)=>e*(t-t*o/100),_=(t,e)=>t*e,m=(t,e)=>t*e*.05,u=t=>"image/notimage.jpg"===t?"./img/no-image.png":`https://shorthaired-veiled-fascinator.glitch.me/${t}`,p=({id:t,title:e,price:o,discount:c,image:n})=>{const i=document.createElement("li");i.className="card",i.tabIndex="0";const s=u(n);return i.innerHTML=`\n  <a href="product.html?id=${t}" class="card__link">\n    <div class="card__image-wrapper">\n      <img src="${s}" alt="${e}" class="card__image" width="420" height="295">\n      ${c>0?`<div class="card__discount">-${c}%</div>`:""}\n    </div>\n  \n    <div class="card__price">\n      <p class="card__new-price">${l(d(o,1,c))}</p>\n      ${c>0?`\n      <p class="card__old-price">\n        <span class="visually-hidden">Старая цена</span>${o} ₽\n      </p>\n      `:""}\n    </div>\n  \n    <p class="card__product">${e}</p>\n  </a>\n  `,i},h="https://shorthaired-veiled-fascinator.glitch.me",y=async()=>{const t=await fetch(`${h}/api/goods`);return await t.json()},v=async t=>{const e=await fetch(`${h}/api/goods/${t}`);return await e.json()},g=e=>t("cart").find((t=>t.id===e)),f=(e,n)=>{e.addEventListener("click",(()=>{const e=g(n);e?o("cart",n,"quantity",e.quantity+1):((e,o)=>{const c=t(e);c.push(o),localStorage.setItem(e,JSON.stringify(c))})("cart",{id:n,quantity:1,checked:!0}),c()}))},q=t=>{t.addEventListener("click",(()=>{var t;t="cart",localStorage.removeItem(t),c()}))},E=()=>0===t("cart").length,k=()=>{document.querySelector("h1").textContent="В корзине пусто...";document.querySelector(".composition__controls").remove()},S=async t=>await Promise.all(t.map((async t=>(async t=>({info:await v(t.id),quantity:t.quantity,checked:t.checked}))(t)))),w=async()=>{const e=t("cart"),{totalPrice:o,totalQuantity:c,totalWithoutDiscount:n,totalDiscount:i}=await(async t=>{const e=await S(t);let o=0,c=0,n=0,i=0;return e.forEach((t=>{if(t.checked){const{price:e,discount:s}=t.info,a=t.quantity;o+=d(e,a,s),c+=a,i+=_(e,a),n+=((t,e,o)=>e*(t*o/100))(e,a,s)}})),{totalPrice:o,totalQuantity:c,totalWithoutDiscount:i,totalDiscount:n}})(e);document.querySelector(".composition__cost").textContent=l(o);document.querySelector(".composition__info-title_goods").textContent=`Товары, ${c} шт.`;document.querySelector(".composition__info_without-discount").textContent=l(n);document.querySelector(".composition__info_discount").textContent=l(i)};(async()=>{if(E())return void k();const n=t("cart"),i=document.querySelector(".composition__cart"),s=document.createElement("ul");s.className="composition__full-order";const a=await S(n),r=a.map((t=>(({id:t,title:e,price:o,discount:c,image:n},i,s)=>{const a=document.createElement("li");a.className="composition__full-product",a.dataset.id=t;const r=u(n);return a.innerHTML=`\n    <div class="composition__column composition__column_item">\n      <input type="checkbox" class="composition__checkbox composition__checkbox_item" ${s?"checked":""}>\n      <img src="${r}" alt="${e}" class="composition__product-image">\n\n      <div class="composition__wrapper">\n        <div class="composition__column composition__column_price composition__column_price_tablet">\n          <div class="composition__new-price">\n            ${l(d(o,i,c))}\n          </div>\n          ${c>0?`\n          <div class="composition__old-price">\n            ${i*o}&nbsp;₽\n          </div>`:""}\n          <div class="composition__credit">\n            В кредит от&nbsp;${l(m(o,i))}\n          </div>\n        </div>\n        <h3 class="composition__product-title">${e}</h3>\n      </div>\n    </div>\n\n    <div class="composition__column composition__column_counter">\n        <button class="composition__count-button composition__count-button_minus">-</button>\n        <p class="composition__quantity">${i}</p>\n        <button class="composition__count-button composition__count-button_plus">+</button>\n\n        <button class="composition__delete composition__delete_item">\n          <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path\n              d="M13.0214 2.35355L13.1679 2.5H13.375H17.25V4H0.75V2.5H4.625H4.83211L4.97855 2.35355L6.08211 1.25H11.9179L13.0214 2.35355ZM4 22.75C2.90114 22.75 2 21.8489 2 20.75V6.25H16V20.75C16 21.8489 15.0989 22.75 14 22.75H4Z"\n              fill="#C9C9C9" stroke="#C9C9C9" />\n          </svg>\n        </button>\n    </div>\n\n    <div class="composition__column composition__column_price composition__column_price_pc">\n      <div class="composition__new-price">\n        ${l(d(o,i,c))}\n      </div>\n      ${c>0?`\n      <div class="composition__old-price">\n        ${i*o}&nbsp;₽\n      </div>`:""}\n      <div class="composition__credit">\n        В кредит от&nbsp;${l(m(o,i))}\n      </div>\n    </div>\n  `,a})(t.info,t.quantity,t.checked)));s.append(...r);const p=document.querySelector(".composition__goods"),h=a.map((t=>(({id:t,title:e,image:o})=>{const c=document.createElement("li");c.className="composition__product",c.dataset.id=t;const n=document.createElement("img");n.alt=e,n.classList.add("composition__product-image","composition__product-image_small");const i=u(o);return n.src=i,c.append(n),c})(t.info)));p.append(...h),i.append(s),await w();let y=!0;n.forEach((t=>{t.checked||(y=!1)}));const v=document.querySelector(".composition__checkbox_all-items");v.checked=y;const b=document.querySelectorAll(".composition__checkbox_item");v.addEventListener("change",(t=>{t.target.checked?b.forEach((e=>{e.checked||e.dispatchEvent(new Event("change")),e.checked=!0,t.target.checked=!0})):b.forEach((e=>{e.checked&&e.dispatchEvent(new Event("change")),e.checked=!1,t.target.checked=!1}))})),b.forEach((t=>{const e=+t.closest("li").dataset.id;((t,e)=>{t.addEventListener("change",(()=>{const t=g(e).checked;o("cart",e,"checked",!t)}))})(t,e),t.addEventListener("change",(()=>{let e=!0;t.checked?b.forEach((t=>{t.checked||(e=!1)})):b.forEach((t=>{t.checked&&(e=!1)})),e&&(t.checked?v.checked=!0:v.checked=!1)}))}));document.querySelectorAll(".composition__checkbox").forEach((t=>{t.addEventListener("change",(async()=>{await w()}))}));const $=document.querySelector(".composition__delete_all");q($),$.addEventListener("click",(async()=>{await w(),k(),s.remove(),p.innerHTML=""}));document.querySelectorAll(".composition__delete_item").forEach((t=>{const o=+t.closest("li").dataset.id;((t,o)=>{t.addEventListener("click",(()=>{e("cart",o),c()}))})(t,o)}));document.querySelectorAll(".composition__count-button_plus").forEach((t=>{const e=+t.closest("li").dataset.id;f(t,e)}));document.querySelectorAll(".composition__count-button_minus").forEach((t=>{const n=+t.closest("li").dataset.id;((t,n)=>{t.addEventListener("click",(()=>{const t=g(n);t.quantity>1?o("cart",n,"quantity",t.quantity-1):e("cart",n),c()}))})(t,n)}));document.querySelectorAll(".composition__count-button, .composition__delete").forEach((t=>{t.addEventListener("click",(async()=>{await w();const e=t.closest("li"),o=+e.dataset.id,c=g(o),n=a.find((t=>t.info.id==o));if(c){const{price:t,discount:o}=n.info,i=c.quantity;e.querySelector(".composition__quantity").textContent=i;e.querySelectorAll(".composition__new-price").forEach((e=>e.textContent=l(d(t,i,o))));e.querySelectorAll(".composition__old-price").forEach((e=>e.textContent=l(_(t,i))));e.querySelectorAll(".composition__credit").forEach((e=>e.textContent=`В кредит от ${l(m(t,i))}`))}else{e.remove();p.querySelector(`[data-id="${o}"`).remove(),E()&&k()}}))}))})();(async()=>{const t=document.querySelector(".profit__container"),e=await(async()=>(await y()).filter((t=>t.discount>0)))(),o=document.createElement("h2");o.className="subtitle",o.textContent="Это выгодно!";const c=document.createElement("ul");c.className="profit__list";const n=e.map(p);c.append(...n),t.append(o,c)})()})();